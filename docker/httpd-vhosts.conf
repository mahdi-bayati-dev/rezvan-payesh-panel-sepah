<VirtualHost *:80>
    ServerName localhost
    DocumentRoot "/usr/local/apache2/htdocs"

    ProxyRequests Off
    ProxyPreserveHost On

    # 1. تنظیمات وب‌سوکت (Soketi)
    # تمام درخواست‌های سوکت را به کانتینر سوکتی می‌فرستیم
    RewriteEngine On
    RewriteCond %{HTTP:Upgrade} =websocket [NC]
    RewriteRule /(.*)           ws://soketi:6001/$1 [P,L]

    # 2. پروکسی دوربین (Camera API) به هاست اصلی
    # نکته: مطمئن شو در docker-compose عبارت extra_hosts: host.docker.internal ست شده باشد
    <Location "/api/cameras-status">
        ProxyPass "http://host.docker.internal:8000/api/cameras-status"
        ProxyPassReverse "http://host.docker.internal:8000/api/cameras-status"
    </Location>

    # 3. دسترسی به فایل‌های آپلودی (Storage)
    Alias /storage "/var/www/storage/app/public"
    <Directory "/var/www/storage/app/public">
        Options Indexes FollowSymLinks
        AllowOverride None
        Require all granted
    </Directory>

    # 4. تنظیمات Backend (Laravel)
    # هدر Auth برای اینکه توکن‌های Bearer گم نشوند
    SetEnvIf Authorization "(.*)" HTTP_AUTHORIZATION=$1

    # هدایت روت‌های بک‌اند به PHP-FPM
    ProxyPassMatch ^/(api|sanctum|broadcasting|telescope)(/.*)?$ fcgi://app:9000/var/www/public/index.php$2

    # 5. تنظیمات Frontend (React)
    <Directory "/usr/local/apache2/htdocs">
        Options Indexes FollowSymLinks
        AllowOverride All
        Require all granted

        # اگر فایل یا پوشه وجود نداشت، index.html را برگردان (برای React Router)
        RewriteEngine On
        RewriteCond %{REQUEST_FILENAME} !-f
        RewriteCond %{REQUEST_FILENAME} !-d
        RewriteRule ^ index.html [QSA,L]
    </Directory>
</VirtualHost>