<VirtualHost *:80>
    ServerName rollcall.kerman.ir
    DocumentRoot "/usr/local/apache2/htdocs"

        <Location "/api/cameras-status">
            # این خط حیاتی است: می‌گوید اگر مسیر این بود، React را صدا نزن!
            FallbackResource disabled

            # هدایت به سرور اصلی پورت 8000
            ProxyPass "http://host.docker.internal:8000/api/cameras-status"
            ProxyPassReverse "http://host.docker.internal:8000/api/cameras-status"
        </Location>

    <Directory "/usr/local/apache2/htdocs">
        Options Indexes FollowSymLinks
        AllowOverride All
        Require all granted
        # فال‌بک برای React Router (اگر فایل پیدا نشد index.html رو بده)
        FallbackResource /index.html
    </Directory>

    # --- تنظیمات پروکسی به لاراول (Backend) ---
    # تمام درخواست‌هایی که با /api شروع می‌شوند به کانتینر app می‌روند
    ProxyPassMatch ^/api/(.*)$ fcgi://app:9000/var/www/public/index.php
    ProxyPassMatch ^/sanctum/(.*)$ fcgi://app:9000/var/www/public/index.php
    ProxyPassMatch ^/broadcasting/(.*)$ fcgi://app:9000/var/www/public/index.php
    ProxyPassMatch ^/telescope(.*)$ fcgi://app:9000/var/www/public/index.php


    RewriteEngine On
    RewriteCond %{HTTP:Authorization} ^(.*)
    RewriteRule .* - [e=HTTP_AUTHORIZATION:%1]
    Alias /storage "/var/www/storage/app/public"
    <Directory "/var/www/storage/app/public">
        Options Indexes FollowSymLinks
        AllowOverride None
        Require all granted
    </Directory>

    # --- تنظیمات وب‌سوکت (Soketi) ---
    RewriteEngine On
    RewriteCond %{HTTP:Upgrade} websocket [NC]
    RewriteCond %{HTTP:Connection} upgrade [NC]
    RewriteRule ^/app/(.*) "ws://soketi:6001/app/$1" [P,L]
</VirtualHost>