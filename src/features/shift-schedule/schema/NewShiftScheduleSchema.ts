import { z } from "zod";

// Regex Ø¨Ø±Ø§ÛŒ ÙØ±Ù…Øª H:i (Ù…Ø«Ø§Ù„: "08:00" ÛŒØ§ "23:59")
const timeRegex = /^([0-1]?[0-9]|2[0-3]):[0-5][0-9]$/;

// Regex Ø¨Ø±Ø§ÛŒ ÙØ±Ù…Øª YYYY-MM-DD
const dateRegex = /^\d{4}-\d{2}-\d{2}$/;

// --- Û±. Ø§Ø³Ú©ÛŒÙ…Ø§ Ø¨Ø±Ø§ÛŒ ÛŒÚ© Ø§Ø³Ù„Ø§Øª ØªÚ©ÛŒ (ÛŒÚ© Ø±ÙˆØ² Ø¯Ø± Ú†Ø±Ø®Ù‡) ---
// Ø§ÛŒÙ† Ø§Ø³Ú©ÛŒÙ…Ø§ Ø¨Ø± Ø§Ø³Ø§Ø³ Ø¨Ø®Ø´ Û±.Û² Ù…Ø³ØªÙ†Ø¯Ø§Øª (Store) Ø§Ø³Øª
const scheduleSlotSchema = z
  .object({
    day_in_cycle: z.number().int().min(1, "Ø±ÙˆØ² Ø¯Ø± Ú†Ø±Ø®Ù‡ Ø§Ù„Ø²Ø§Ù…ÛŒ Ø§Ø³Øª"),
    is_off: z.boolean(),
    // âœ…âœ…âœ… Ø§ØµÙ„Ø§Ø­ Ú©Ù„ÛŒØ¯ÛŒ: ØªØ§ÛŒÙ¾â€ŒÙ‡Ø§ Ø¨Ø§ÛŒØ¯ nullable Ø¨Ø§Ø´Ù†Ø¯ ØªØ§ Ø¨Ø§ null Ú©Ø±Ø¯Ù† Ø¯Ø± Ù‡ÙˆÚ© Ù…Ø·Ø§Ø¨Ù‚Øª Ú©Ù†Ù†Ø¯
    name: z.string().nullable(),
    start_time: z.string().nullable(),
    end_time: z.string().nullable(),
  })
  .superRefine((data, ctx) => {
    // --- Ø§Ø¹ØªØ¨Ø§Ø±Ø³Ù†Ø¬ÛŒ Ø´Ø±Ø·ÛŒ Ø¨Ø± Ø§Ø³Ø§Ø³ Ù…Ø³ØªÙ†Ø¯Ø§Øª API ---
    // (required_if:is_off,false)
    if (!data.is_off) {
      // Û±. Ø§Ø¹ØªØ¨Ø§Ø±Ø³Ù†Ø¬ÛŒ Ù†Ø§Ù…
      if (!data.name || data.name.trim() === "") {
        ctx.addIssue({
          code: z.ZodIssueCode.custom,
          message: "Ù†Ø§Ù… Ø´ÛŒÙØª Ø¨Ø±Ø§ÛŒ Ø±ÙˆØ² Ú©Ø§Ø±ÛŒ Ø§Ù„Ø²Ø§Ù…ÛŒ Ø§Ø³Øª",
          path: ["name"],
        });
      }

      // Û². Ø§Ø¹ØªØ¨Ø§Ø±Ø³Ù†Ø¬ÛŒ Ø²Ù…Ø§Ù† Ø´Ø±ÙˆØ¹
      if (!data.start_time || !timeRegex.test(data.start_time)) {
        ctx.addIssue({
          code: z.ZodIssueCode.custom,
          message: "Ø²Ù…Ø§Ù† Ø´Ø±ÙˆØ¹ Ù…Ø¹ØªØ¨Ø± (H:i) Ø§Ù„Ø²Ø§Ù…ÛŒ Ø§Ø³Øª",
          path: ["start_time"],
        });
      }

      // Û³. Ø§Ø¹ØªØ¨Ø§Ø±Ø³Ù†Ø¬ÛŒ Ø²Ù…Ø§Ù† Ù¾Ø§ÛŒØ§Ù†
      if (!data.end_time || !timeRegex.test(data.end_time)) {
        ctx.addIssue({
          code: z.ZodIssueCode.custom,
          message: "Ø²Ù…Ø§Ù† Ù¾Ø§ÛŒØ§Ù† Ù…Ø¹ØªØ¨Ø± (H:i) Ø§Ù„Ø²Ø§Ù…ÛŒ Ø§Ø³Øª",
          path: ["end_time"],
        });
      }

      // âœ…âœ…âœ… Ø§ØµÙ„Ø§Ø­ Ú©Ù„ÛŒØ¯ÛŒ Ùˆ Ø¨Ø³ÛŒØ§Ø± Ù…Ù‡Ù… (ØªØ·Ø§Ø¨Ù‚ Ø¨Ø§ Ù…Ø³ØªÙ†Ø¯Ø§Øª Ø¨Ø®Ø´ Û±.Û²) âœ…âœ…âœ…
      // Ù…Ø³ØªÙ†Ø¯Ø§Øª Ø´Ù…Ø§ Ø¨Ù‡ ØµØ±Ø§Ø­Øª ÛŒÚ© Ù…Ø«Ø§Ù„ Ø´ÛŒÙØª Ø´Ø¨ ("22:00" ØªØ§ "06:00") Ø±Ø§ Ù…Ø¬Ø§Ø² Ù…ÛŒâ€ŒØ¯Ø§Ù†Ø¯.
      // Ø¨Ù†Ø§Ø¨Ø±Ø§ÛŒÙ†ØŒ Ù…Ø§ *Ù†Ø¨Ø§ÛŒØ¯* Ø¯Ø± ÙØ±Ø§Ù†Øªâ€ŒØ§Ù†Ø¯ Ø§Ø¹ØªØ¨Ø§Ø±Ø³Ù†Ø¬ÛŒ (end_time > start_time) Ø±Ø§ Ø§Ù†Ø¬Ø§Ù… Ø¯Ù‡ÛŒÙ….
      // Ø§ÛŒÙ† Ø§Ø¹ØªØ¨Ø§Ø±Ø³Ù†Ø¬ÛŒ (Ø§Ú¯Ø± ÙˆØ¬ÙˆØ¯ Ø¯Ø§Ø´ØªÙ‡ Ø¨Ø§Ø´Ø¯) Ø¨Ø§ÛŒØ¯ ØªÙˆØ³Ø· Ø¨Ú©â€ŒØ§Ù†Ø¯ Ù…Ø¯ÛŒØ±ÛŒØª Ø´ÙˆØ¯.
      // Ø­Ø°Ù Ø§ÛŒÙ† Ø¨Ø®Ø´ØŒ Ø§Ù…Ú©Ø§Ù† Ø§Ø±Ø³Ø§Ù„ Ø´ÛŒÙØª Ø´Ø¨ Ø±Ø§ ÙØ±Ø§Ù‡Ù… Ù…ÛŒâ€ŒÚ©Ù†Ø¯.

      /*
      // Ø§ÛŒÙ† Ú©Ø¯ Ø­Ø°Ù Ø´Ø¯ ØªØ§ Ø´ÛŒÙØª Ø´Ø¨ Ù…Ø¬Ø§Ø² Ø¨Ø§Ø´Ø¯
      if (data.start_time && data.end_time && timeRegex.test(data.start_time) && timeRegex.test(data.end_time)) {
        const [startHours, startMinutes] = data.start_time.split(":").map(Number);
        const [endHours, endMinutes] = data.end_time.split(":").map(Number);
        const startTimeInMinutes = startHours * 60 + startMinutes;
        let endTimeInMinutes = endHours * 60 + endMinutes;

        // Ø§Ú¯Ø± Ù¾Ø§ÛŒØ§Ù† Ú©ÙˆÚ†Ú©ØªØ± Ø§Ø² Ø´Ø±ÙˆØ¹ Ø¨ÙˆØ¯ (Ø´ÛŒÙØª Ø´Ø¨)
        if (endTimeInMinutes < startTimeInMinutes) {
           // Ø¯Ø± Ø§ÛŒÙ†Ø¬Ø§ Ø§Ø¹ØªØ¨Ø§Ø±Ø³Ù†Ø¬ÛŒ Ø§Ù†Ø¬Ø§Ù… Ù†Ù…ÛŒâ€ŒØ¯Ù‡ÛŒÙ…
        } else if (endTimeInMinutes === startTimeInMinutes) {
            ctx.addIssue({
                code: z.ZodIssueCode.custom,
                message: "Ù¾Ø§ÛŒØ§Ù† Ù†Ù…ÛŒâ€ŒØªÙˆØ§Ù†Ø¯ Ø¨Ø§ Ø´Ø±ÙˆØ¹ ÛŒÚ©Ø³Ø§Ù† Ø¨Ø§Ø´Ø¯",
                path: ["end_time"],
            });
        }
      }
      */
    }
  });

// --- Û². Ø§Ø³Ú©ÛŒÙ…Ø§ÛŒ Ø§ØµÙ„ÛŒ ÙØ±Ù… Ø§ÛŒØ¬Ø§Ø¯ Ø¨Ø±Ù†Ø§Ù…Ù‡ Ø´ÛŒÙØªÛŒ ---
export const newShiftScheduleSchema = z
  .object({
    name: z
      .string()
      .min(1, "Ù†Ø§Ù… Ø¨Ø±Ù†Ø§Ù…Ù‡ Ø´ÛŒÙØªÛŒ Ø§Ù„Ø²Ø§Ù…ÛŒ Ø§Ø³Øª")
      .max(255, "Ù†Ø§Ù… Ø¨Ø±Ù†Ø§Ù…Ù‡ Ø·ÙˆÙ„Ø§Ù†ÛŒ Ø§Ø³Øª"),

    cycle_length_days: z
      // ğŸŸ¢ğŸŸ¢ğŸŸ¢ Ø±Ø§Ù‡â€ŒØ­Ù„ Ø®Ø·Ø§ÛŒ 2: ğŸŸ¢ğŸŸ¢ğŸŸ¢
      // Ú©Ù„ÛŒØ¯ 'invalid_type_error' Ø¨Ù‡ 'message' ØªØºÛŒÛŒØ± Ú©Ø±Ø¯
      // ØªØ§ Ø¨Ø§ Ú©Ø§Ù†ÙÛŒÚ¯ Zod/TS Ø´Ù…Ø§ Ù…Ø·Ø§Ø¨Ù‚Øª Ø¯Ø§Ø´ØªÙ‡ Ø¨Ø§Ø´Ø¯.
      .number({ message: "Ø·ÙˆÙ„ Ú†Ø±Ø®Ù‡ Ø¨Ø§ÛŒØ¯ Ø¹Ø¯Ø¯ Ø¨Ø§Ø´Ø¯." }) // Ø¨Ù‡Ø¨ÙˆØ¯ Ù¾ÛŒØ§Ù… Ø®Ø·Ø§
      .int({ message: "Ø·ÙˆÙ„ Ú†Ø±Ø®Ù‡ Ø¨Ø§ÛŒØ¯ Ø¹Ø¯Ø¯ ØµØ­ÛŒØ­ Ø¨Ø§Ø´Ø¯." })
      .min(1, "Ø·ÙˆÙ„ Ú†Ø±Ø®Ù‡ Ø¨Ø§ÛŒØ¯ Ø­Ø¯Ø§Ù‚Ù„ Û± Ø±ÙˆØ² Ø¨Ø§Ø´Ø¯.")
      .max(31, "Ø·ÙˆÙ„ Ú†Ø±Ø®Ù‡ Ù†Ø¨Ø§ÛŒØ¯ Ø¨ÛŒØ´ØªØ± Ø§Ø² Û³Û± Ø±ÙˆØ² Ø¨Ø§Ø´Ø¯."), // Ø³Ù‚Ù API (Ø¨Ø®Ø´ Û±.Û²)

    cycle_start_date: z
      .string()
      .min(1, "ØªØ§Ø±ÛŒØ® Ø´Ø±ÙˆØ¹ Ú†Ø±Ø®Ù‡ Ø§Ù„Ø²Ø§Ù…ÛŒ Ø§Ø³Øª.")
      .refine((val) => dateRegex.test(val), "ÙØ±Ù…Øª ØªØ§Ø±ÛŒØ® Ø¨Ø§ÛŒØ¯ YYYY-MM-DD Ø¨Ø§Ø´Ø¯."),

    // âœ… ÙÛŒÙ„Ø¯ Ø¬Ø¯ÛŒØ¯ Ø¨Ø±Ø§ÛŒ Ù†Ø§Ø¯ÛŒØ¯Ù‡ Ú¯Ø±ÙØªÙ† ØªØ¹Ø·ÛŒÙ„Ø§Øª Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯
    ignore_holidays: z.boolean(),

    // âœ…âœ…âœ… Ø§ØµÙ„Ø§Ø­ Ú©Ù„ÛŒØ¯ÛŒ: Ø­Ø¯Ø§Ù‚Ù„ Ø§Ø³Ù„Ø§Øªâ€ŒÙ‡Ø§ Ø¨Ø§ÛŒØ¯ Û° Ø¨Ø§Ø´Ø¯
    // Ú†ÙˆÙ† Ù…Ù†Ø·Ù‚ "Ù…Ù†Ø·Ù‚ Ø¯Ø§Ø®Ù„ÛŒ" Ø¯Ø± Ù…Ø³ØªÙ†Ø¯Ø§Øª (Ø¨Ø®Ø´ Û±.Û²) Ù…ÛŒâ€ŒÚ¯ÙˆÛŒØ¯:
    // "Ø¨Ø±Ø§ÛŒ ØªÙ…Ø§Ù… Ø±ÙˆØ²Ù‡Ø§ÛŒ Ø¯ÛŒÚ¯Ø±... Ú©Ù‡ Ø¯Ø± Ø¢Ø±Ø§ÛŒÙ‡ slots Ù†Ø¨Ø§Ø´Ù†Ø¯ØŒ Ø¨Ù‡ ØµÙˆØ±Øª Ø®ÙˆØ¯Ú©Ø§Ø± Ø§Ø³Ù„Ø§Øª ØªØ¹Ø·ÛŒÙ„ Ø§ÛŒØ¬Ø§Ø¯ Ù…ÛŒâ€ŒÚ©Ù†Ø¯."
    // Ø§ÛŒÙ† ÛŒØ¹Ù†ÛŒ Ø§Ø±Ø³Ø§Ù„ Ø¢Ø±Ø§ÛŒÙ‡ Ø®Ø§Ù„ÛŒ Ù‡Ù… Ù…Ø¬Ø§Ø² Ø§Ø³Øª (Ø§Ú¯Ø±Ú†Ù‡ Ø¯Ø± ÙØ±Ù… Ù…Ø§ Ø§ÛŒÙ† Ø§ØªÙØ§Ù‚ Ù†Ù…ÛŒâ€ŒØ§ÙØªØ¯)
    // Ø§Ù…Ø§ Ù…Ù‡Ù…â€ŒØªØ± Ø§Ø² Ø¢Ù†ØŒ Ø§Ø¹ØªØ¨Ø§Ø±Ø³Ù†Ø¬ÛŒ min(1) Ø¯Ø± useShiftScheduleForm Ù…Ø´Ú©Ù„â€ŒØ³Ø§Ø² Ù…ÛŒâ€ŒØ´ÙˆØ¯.
    // Ù…Ø§ Ø§Ø¹ØªØ¨Ø§Ø±Ø³Ù†Ø¬ÛŒ ØªØ·Ø§Ø¨Ù‚ Ø·ÙˆÙ„ Ø¢Ø±Ø§ÛŒÙ‡ Ø±Ø§ Ø¯Ø± superRefine Ø¯Ø§Ø±ÛŒÙ….
    slots: z.array(scheduleSlotSchema),
  })
  .superRefine((data, ctx) => {
    // Ø§Ø¹ØªØ¨Ø§Ø±Ø³Ù†Ø¬ÛŒ Ø¨Ø±Ø§ÛŒ ØªØ·Ø¨ÛŒÙ‚ ØªØ¹Ø¯Ø§Ø¯ Ø§Ø³Ù„Ø§Øªâ€ŒÙ‡Ø§ Ø¨Ø§ Ø·ÙˆÙ„ Ú†Ø±Ø®Ù‡
    // Ø§ÛŒÙ† Ø§Ø¹ØªØ¨Ø§Ø±Ø³Ù†Ø¬ÛŒ Ø§Ú©Ù†ÙˆÙ† ØªÙ†Ù‡Ø§ Ø§Ø¹ØªØ¨Ø§Ø±Ø³Ù†Ø¬ÛŒ Ø±ÙˆÛŒ Ø§Ø³Ù„Ø§Øªâ€ŒÙ‡Ø§ Ø§Ø³Øª Ùˆ ØµØ­ÛŒØ­ Ø§Ø³Øª
    const targetLength = data.cycle_length_days;
    const slotsLength = data.slots?.length ?? 0;

    if (
      !isNaN(targetLength) &&
      targetLength > 0 &&
      slotsLength !== targetLength
    ) {
      ctx.addIssue({
        code: z.ZodIssueCode.custom,
        message: `ØªØ¹Ø¯Ø§Ø¯ Ø§Ø³Ù„Ø§Øªâ€ŒÙ‡Ø§ (${slotsLength}) Ø¨Ø§ Ø·ÙˆÙ„ Ú†Ø±Ø®Ù‡ (${targetLength}) Ù…Ø·Ø§Ø¨Ù‚Øª Ù†Ø¯Ø§Ø±Ø¯.`,
        path: ["cycle_length_days"], // Ø®Ø·Ø§ Ø±Ø§ Ø±ÙˆÛŒ ÙÛŒÙ„Ø¯ Ø·ÙˆÙ„ Ú†Ø±Ø®Ù‡ Ù†Ø´Ø§Ù† Ù…ÛŒâ€ŒØ¯Ù‡ÛŒÙ…
      });
    }
  });

// --- Û³. ØªØ§ÛŒÙ¾ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ ÙØ±Ù… ---
export type NewShiftScheduleFormData = z.infer<typeof newShiftScheduleSchema>;
