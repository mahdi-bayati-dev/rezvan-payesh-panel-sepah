<?php
 namespace App\Events; use App\Http\Resources\LeaveRequestResource; use App\Models\LeaveRequest; use Illuminate\Broadcasting\Channel; use Illuminate\Broadcasting\InteractsWithSockets; use Illuminate\Broadcasting\PresenceChannel; use Illuminate\Broadcasting\PrivateChannel; use Illuminate\Contracts\Broadcasting\ShouldBroadcast; use Illuminate\Foundation\Events\Dispatchable; use Illuminate\Queue\SerializesModels; use Illuminate\Support\Facades\Log; class LeaveRequestSubmitted implements ShouldBroadcast { use Dispatchable, InteractsWithSockets, SerializesModels; public function __construct(public LeaveRequest $leaveRequest) { $this->leaveRequest = $leaveRequest->load('employee.organization.ancestors'); } public function broadcastOn(): array { $channels = []; $channels[] = new PrivateChannel('super-admin-global'); $organization = $this->leaveRequest->employee->organization; Log::info("leave request event starting.... $organization"); if (!$this->leaveRequest->employee || !$organization) { return $channels; } $channels[] = new PrivateChannel('l3-channel.' . $organization->id); Log::info("leave request admin l3 added... $organization->id"); $allAncestors = $organization->ancestors; $allAncestors->push($organization); foreach ($allAncestors as $org) { if ($org && $org->id) { $channels[] = new PrivateChannel('l2-channel.' . $org->id); } } Log::info("leave request admin l2 added..."); return array_unique($channels); } public function broadcastAs(): string { return 'leave_request.submitted'; } public function broadcastWith(): array { return ['request' => new LeaveRequestResource( $this->leaveRequest)]; } } 