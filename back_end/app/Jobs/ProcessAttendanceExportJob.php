<?php
 namespace App\Jobs; use App\Events\ExportReady; use App\Exports\AttendanceLogExport; use App\Models\User; use Illuminate\Bus\Queueable; use Illuminate\Contracts\Queue\ShouldQueue; use Illuminate\Foundation\Bus\Dispatchable; use Illuminate\Queue\InteractsWithQueue; use Illuminate\Queue\SerializesModels; use Illuminate\Support\Facades\Log; use Illuminate\Support\Facades\Storage; use Illuminate\Support\Facades\URL; use Maatwebsite\Excel\Facades\Excel; class ProcessAttendanceExportJob implements ShouldQueue { use Dispatchable, InteractsWithQueue, Queueable, SerializesModels; public function __construct(protected User $user,protected array $options,protected string $filename) { } public function handle(): void { try { Excel::store( new AttendanceLogExport($this->user, $this->options), $this->filename, 'local_reports' ); Log::info("Attendance log ( $this->filename ) export finished."); $downloadUrl = URL::temporarySignedRoute( 'reports.download', now()->addMinutes(120), ['filename' => $this->filename] ); Log::info("downloading $downloadUrl"); ExportReady::dispatch($this->user, $downloadUrl, 'گزارش ترددها'); } catch (\Exception $e) { Log::error("Failed to generate attendance report for user {$this->user->id}: " . $e->getMessage()); } } } 