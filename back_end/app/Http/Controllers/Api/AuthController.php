<?php
 namespace App\Http\Controllers\Api; use App\Http\Controllers\Controller; use App\Models\User; use Illuminate\Http\Request; use Illuminate\Support\Facades\Hash; class AuthController extends Controller { public function login(Request $request) { $request->validate([ 'user_name' => 'required|string', 'password' => 'required|string', ]); $user = User::where('user_name', $request->user_name)->first(); if (!$user || !Hash::check($request->password, $user->password)) { return response()->json([ 'error' => 'Unauthorized', 'message' => 'نام کاربری یا رمز عبور نامعتبر است.' ], 401); } if ($user->status !== 'active') { return response()->json([ 'error' => 'Unauthorized', 'message' => 'حساب کاربری شما غیرفعال است.' ], 401); } $tokenResult = $user->createToken('AuthToken'); $token = $tokenResult->accessToken; if(config('app.auth_type') === 'token') { $expiresAt = $tokenResult->token->expires_at; return response()->json( [ 'access_token' => $token, 'token_type' => 'Bearer', 'expires_at' => $expiresAt->toDateTimeString(), 'user' => [ 'id' => $user->id, 'user_name' => $user->user_name, 'email' => $user->email, 'roles' => $user->getRoleNames(), ] ]); } elseif (config('app.auth_type') === 'http_only') { $domain = config('SESSION_DOMAIN'); $cookie = cookie( 'access_token', $token, 360, '/', $domain, true, true, false, 'Lax' ); return response()->json([ 'message' => 'Login successful', 'user' => [ 'id' => $user->id, 'user_name' => $user->user_name, 'email' => $user->email, 'roles' => $user->getRoleNames(), ], 'expires_at' => $tokenResult->token->expires_at->toDateTimeString(), ])->withCookie($cookie); } else { return response()->json(["error" => "env => auth type"], 401); } } public function logout(Request $request) { if(config('app.auth_type') === 'token') { $request->user()->token()->revoke(); } elseif (config('app.auth_type') === 'http_only') { if ($request->user()) { $request->user()->token()->revoke(); } $domain = config('SESSION_DOMAIN'); $cookie = cookie( 'access_token', '', -1, '/', $domain, true, true, false, 'Lax' ); return response()->json([ 'message' => 'خروج با موفقیت انجام شد.' ])->withCookie($cookie); } return response()->json(['message' => 'خروج با موفقیت انجام شد.']); } } 