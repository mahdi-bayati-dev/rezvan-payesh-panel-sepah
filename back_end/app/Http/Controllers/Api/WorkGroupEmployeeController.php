<?php
 namespace App\Http\Controllers\Api; use App\Http\Controllers\Controller; use App\Models\Employee; use App\Models\WorkGroup; use Illuminate\Http\Request; use Illuminate\Http\JsonResponse; use Illuminate\Support\Facades\DB; class WorkGroupEmployeeController extends Controller { public function updateEmployees(Request $request, WorkGroup $workGroup): JsonResponse { $this->authorize('update', $workGroup); $validated = $request->validate([ 'employee_ids' => 'required|array', 'employee_ids.*' => 'exists:employees,id', 'action' => 'required|in:attach,detach', ]); $employeeIds = $validated['employee_ids']; $action = $validated['action']; DB::beginTransaction(); try { if ($action === 'attach') { Employee::whereIn('id', $employeeIds)->update([ 'work_group_id' => $workGroup->id ]); $message = 'کارمندان با موفقیت به گروه اضافه شدند.'; } else { Employee::whereIn('id', $employeeIds)->update([ 'work_group_id' => null ]); $message = 'کارمندان با موفقیت از گروه حذف شدند.'; } DB::commit(); return response()->json([ 'message' => $message, 'current_count' => $workGroup->employee()->count() ]); } catch (\Exception $e) { DB::rollBack(); return response()->json([ 'message' => 'خطا در انجام عملیات.', 'error' => $e->getMessage() ], 500); } } }