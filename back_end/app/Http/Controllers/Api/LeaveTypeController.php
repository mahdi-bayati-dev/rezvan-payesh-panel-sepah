<?php
 namespace App\Http\Controllers\Api; use App\Http\Controllers\Controller; use App\Http\Resources\LeaveTypeResource; use App\Models\LeaveType; use Illuminate\Http\Request; use Illuminate\Support\Facades\Validator; use Illuminate\Validation\Rule; class LeaveTypeController extends Controller { public function __construct() { $this->middleware('role:super_admin')->except('index'); } public function index() { $rootLeaveTypes = LeaveType::whereNull('parent_id') ->with('allChildren') ->orderBy('name') ->get(); return LeaveTypeResource::collection($rootLeaveTypes); } public function store(Request $request) { $validator = Validator::make($request->all(), [ 'name' => 'required|string|max:255|unique:leave_types,name', 'description' => 'nullable|string', 'parent_id' => 'nullable|integer|exists:leave_types,id' ]); if ($validator->fails()) { return response()->json(['errors' => $validator->errors()], 422); } $leaveType = LeaveType::create($validator->validated()); return (new LeaveTypeResource($leaveType)) ->response() ->setStatusCode(201); } public function show(LeaveType $leaveType) { $leaveType->load(['parent', 'allChildren']); return new LeaveTypeResource($leaveType); } public function update(Request $request, LeaveType $leaveType) { $validator = Validator::make($request->all(), [ 'name' => [ 'required', 'string', 'max:255', Rule::unique('leave_types')->ignore($leaveType->id) ], 'description' => 'nullable|string', 'parent_id' => [ 'nullable', 'integer', 'exists:leave_types,id', Rule::notIn([$leaveType->id]) ] ]); if ($validator->fails()) { return response()->json(['errors' => $validator->errors()], 422); } $leaveType->update($validator->validated()); return new LeaveTypeResource($leaveType); } public function destroy(LeaveType $leaveType) { if ($leaveType->leaveRequests()->exists()) { return response()->json([ 'message' => 'Cannot delete this type because it is assigned to one or more leave requests.' ], 409); } $leaveType->delete(); return response()->json(null, 204); } } 