<?php
 namespace App\Http\Controllers\Api; use App\Http\Controllers\Controller; use App\Http\Resources\ScheduleSlotResource; use App\Jobs\GenerateEmployeeShifts; use App\Models\ScheduleSlot; use App\Models\ShiftSchedule; use Carbon\Carbon; use Illuminate\Http\Request; use Illuminate\Support\Facades\Log; use Illuminate\Support\Facades\Validator; class ScheduleSlotController extends Controller { public function update(Request $request,ShiftSchedule $shiftSchedule, ScheduleSlot $scheduleSlot) { $validator = Validator::make($request->all(), [ 'work_pattern_id' => 'nullable|exists:work_patterns,id', 'override_start_time' => 'nullable|date_format:H:i', 'override_end_time' => [ 'nullable', 'date_format:H:i', function ($attribute, $value, $fail) use ($request) { if ($request->input('override_start_time') && $value && $value <= $request->input('override_start_time')) { $fail('The override end time must be after the override start time.'); } }], ]); if ($validator->fails()) { return response()->json(['errors' => $validator->errors()], 422); } $validatedData = $validator->validated(); if (array_key_exists('work_pattern_id', $validatedData) && is_null($validatedData['work_pattern_id'])) { $validatedData['override_start_time'] = null; $validatedData['override_end_time'] = null; } $validatedData = $validator->validated(); $scheduleSlot->update($validatedData); if ($scheduleSlot->wasChanged(['work_pattern_id', 'override_start_time', 'override_end_time'])) { Log::info("اسلات ID {$scheduleSlot->id} در برنامه ID {$shiftSchedule->id} تغییر کرد. اجرای مجدد GenerateEmployeeShifts."); GenerateEmployeeShifts::dispatch( $shiftSchedule->id, Carbon::today(), Carbon::today()->addDays(30) ); } return new ScheduleSlotResource($scheduleSlot->load('workPattern')); } } 