<?php
 namespace App\Policies; use App\Models\User; use Illuminate\Auth\Access\HandlesAuthorization; use Illuminate\Auth\Access\Response; class UserPolicy { use HandlesAuthorization; public function viewAny(User $user): bool { return $user->hasAnyRole(['org-admin-l2', 'org-admin-l3']); } public function view(User $user, User $model): bool { if ($user->id === $model->id) { return true; } $userEmployeeProfile = $user->employee; $modelEmployeeProfile = $model->employee; if (!$userEmployeeProfile?->organization_id || !$modelEmployeeProfile?->organization_id) { return false; } $adminOrg = $userEmployeeProfile->organization; $targetOrg = $modelEmployeeProfile->organization; if ($user->hasRole('org-admin-l2')) { return $adminOrg && $targetOrg && $targetOrg->ancestors()->where('id', $adminOrg->id)->exists(); } if ($user->hasRole('org-admin-l3')) { return $userEmployeeProfile->organization_id === $modelEmployeeProfile->organization_id; } return false; } public function create(User $user): bool { return $user->hasAnyRole(['org-admin-l2', 'org-admin-l3']); } public function update(User $user, User $model): bool { if ($user->id === $model->id) { return true; } $canView = $this->view($user, $model); $targetIsAdmin = $model->hasAnyRole(['super-admin', 'org-admin-l2', 'org-admin-l3']); if ($user->hasAnyRole(['org-admin-l2', 'org-admin-l3'])) { return $canView && !$targetIsAdmin; } return false; } public function delete(User $user, User $model): bool { if ($user->id === $model->id) { return false; } if ($user->hasRole('user')) { return false; } $canView = $this->view($user, $model); $targetIsAdmin = $model->hasAnyRole(['super-admin', 'org-admin-l2', 'org-admin-l3']); if ($user->hasAnyRole(['org-admin-l2', 'org-admin-l3'])) { return $canView && !$targetIsAdmin; } return false; } public function restore(User $user, User $model): bool { return false; } public function forceDelete(User $user, User $model): bool { return false; } } 