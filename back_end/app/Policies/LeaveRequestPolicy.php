<?php
 namespace App\Policies; use App\Models\LeaveRequest; use App\Models\Organization; use App\Models\User; use Illuminate\Auth\Access\HandlesAuthorization; use Illuminate\Auth\Access\Response; use Illuminate\Support\Facades\Log; class LeaveRequestPolicy { use HandlesAuthorization; public function before(User $user, string $ability) { if ($user->hasRole('super_admin')) { return true; } } public function viewAny(User $user): bool { return $user->hasAnyRole(['org-admin-l2', 'org-admin-l3']); } public function see(User $user , Organization $organization): bool { if(!$user->hasAnyRole(['org-admin-l2', 'org-admin-l3'])) { return false; } $targetOrg = Organization::find($organization->id); $manager_org_id = $user->employee->organization_id; if (!$manager_org_id || !$manager_org_id->organization) { Log::warning("User {$user->id} has admin role but no employee profile or organization."); return false; } if (!isset($targetOrg)) { Log::warning("the selected org is not valid"); return false; } if($user->hasRole("org-admin-l3")) { return $manager_org_id == $targetOrg->id; } elseif ($user->hasRole("org-admin-l2")) { return $manager_org_id && $targetOrg->ancestors()->where('id', $manager_org_id->id)->exists(); } return false; } public function view(User $user, LeaveRequest $leaveRequest): bool { if ($user->employee?->id === $leaveRequest->employee_id) { return true; } return $this->process($user, $leaveRequest); } public function create(User $user): bool { return $user->employee()->exists(); } public function update(User $user, LeaveRequest $leaveRequest): bool { if (!$leaveRequest->isPending()) { return false; } if ($user->employee?->id === $leaveRequest->employee_id) { return true; } return $this->process($user, $leaveRequest); } public function delete(User $user, LeaveRequest $leaveRequest): bool { return $user->employee?->id === $leaveRequest->employee_id && $leaveRequest->isPending(); } public function restore(User $user, LeaveRequest $leaveRequest): bool { return false; } public function forceDelete(User $user, LeaveRequest $leaveRequest): bool { return false; } public function process(User $user, LeaveRequest $leaveRequest): bool { if (!$user->hasAnyRole(['org-admin-l2', 'org-admin-l3'])) { return false; } $managerEmployee = $user->employee; if (!$managerEmployee || !$managerEmployee->organization) { Log::warning("User {$user->id} has admin role but no employee profile or organization."); return false; } $requestEmployee = $leaveRequest->employee; if (!$requestEmployee || !$requestEmployee->organization) { Log::warning("LeaveRequest {$leaveRequest->id} cannot be processed because its employee {$leaveRequest->employee_id} has no organization."); return false; } $managerOrgId = $managerEmployee->organization_id; $requestEmployeeOrg = $requestEmployee->organization; if($managerEmployee->id === $requestEmployee->id) { Log::warning("LeaveRequest {$leaveRequest->id} cannot be processed because its employee {$leaveRequest->employee_id} is the manager organization itself."); return false; } if ($user->hasRole('org-admin-l3')) { return $requestEmployeeOrg->id === $managerOrgId; } if ($user->hasRole('org-admin-l2')) { return $managerOrgId && $requestEmployeeOrg->ancestors()->where('id', $managerOrgId->id)->exists(); } return false; } }