<?php
 namespace App\Providers; use App\Policies\DevicesPolicy; use Illuminate\Foundation\Support\Providers\AuthServiceProvider as ServiceProvider; use App\Models\AttendanceLog; use App\Models\Employee; use App\Models\Holiday; use App\Models\LeaveRequest; use App\Models\Organization; use App\Models\ScheduleSlot; use App\Models\ShiftSchedule; use App\Models\User; use App\Models\WorkGroup; use App\Models\WorkPattern; use App\Policies\AttendanceLogPolicy; use App\Policies\EmployeePolicy; use App\Policies\HolidayPolicy; use App\Policies\LeaveRequestPolicy; use App\Policies\OrganizationPolicy; use App\Policies\ScheduleSlotPolicy; use App\Policies\ShiftSchedulePolicy; use App\Policies\UserPolicy; use App\Policies\WorkGroupPolicy; use App\Policies\WorkPatternPolicy; use Carbon\CarbonInterval; use Illuminate\Support\Facades\Broadcast; use Illuminate\Support\Facades\Gate; use Laravel\Passport\Passport; use Spatie\Permission\Models\Role; class AuthServiceProvider extends ServiceProvider { protected $policies = [ Employee::class => EmployeePolicy::class, Organization::class => OrganizationPolicy::class, User::class => UserPolicy::class, WorkGroup::class => WorkGroupPolicy::class, WorkPattern::class => WorkPatternPolicy::class, AttendanceLog::class => AttendanceLogPolicy::class, LeaveRequest::class => LeaveRequestPolicy::class, Holiday::class => HolidayPolicy::class, ScheduleSlot::class => ScheduleSlotPolicy::class, ShiftSchedule::class => ShiftSchedulePolicy::class, DevicesPolicy::class => DevicesPolicy::class, ]; public function register(): void { } public function boot(): void { Passport::loadKeysFrom(__DIR__.'/../../secrets/oauth'); Passport::tokensExpireIn(CarbonInterval::days(15)); Passport::refreshTokensExpireIn(CarbonInterval::days(30)); Passport::personalAccessTokensExpireIn(CarbonInterval::months(6)); Gate::before(function ($user, $ability) { return $user->hasRole('super_admin') ? true : null; }); Gate::define('access-organization', function (User $user, Organization $organization) { $organizationIdsToScan = $organization->ancestors->pluck('id')->all(); $organizationIdsToScan[] = $organization->id; $adminRole = Role::findByName('admin'); if (!$adminRole) { return false; } return $user->roles() ->wherePivot('team_id', '!=', null) ->where('id', $adminRole->id) ->whereIn(config('permission.table_names.model_has_roles') . '.team_id', $organizationIdsToScan) ->exists(); }); $this->registerPolicies(); Gate::define('viewPulse', function (User $user) { return $user->hasRole('super_admin'); }); } } 